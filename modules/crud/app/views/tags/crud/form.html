%{
	// Eval fields tags
	def fieldsHandler = [:]
	if(_body) {
		_body.setProperty('fieldsHandler', fieldsHandler);
		_body.toString(); // we skeep the real result ...
	}
}%

#{list items:_fields ?: _caller.type.fields*.name, as:'fieldName'}

	%{
		am = ''
	}%

	<div class="crudField">

	%{ def field = _caller.type.getField(fieldName) }%
	
	%{ if(fieldsHandler[fieldName]) { }%
		%{
			def handler = fieldsHandler[fieldName];
			handler.setProperty('fieldName', 'object.' + field.name);
			handler.setProperty('object', _caller.object);
			out.println(handler.toString());
			handler.setProperty('object', null);
			handler.setProperty('fieldName', null);
		}%
	%{ } else { }%
		
		#{if field.type == 'text'}
			#{crud.textField name:field.name, value:(_caller.object ? _caller.object[field.name] : null) /}
		#{/if}
		
		#{if field.type == 'file'}
			#{crud.fileField name:field.name, value:(_caller.object ? _caller.object[field.name] : null), id:_caller.object?.id /}
		#{/if}
		
		#{if field.type == 'longtext'}
			#{crud.longtextField name:field.name, value:(_caller.object ? _caller.object[field.name] : null) /}
		#{/if}

		#{if field.type == 'number'}
			#{crud.numberField name:field.name, value:(_caller.object ? _caller.object[field.name] : null) /}
			%{ am = 'crud.help.numeric' }%
		#{/if}
		
		#{if field.type == 'date'}
			#{crud.dateField name:field.name, value:(_caller.object ? _caller.object[field.name] : null) /}
			%{ am = 'crud.help.dateformat' }%
		#{/if}

		#{if field.type == 'relation'}
			#{crud.relationField name:field.name, value:(_caller.object ? _caller.object[field.name] : null), field:field /}
		#{/if}
		
		#{if field.type == 'boolean'}
			#{crud.checkField name:field.name, value:(_caller.object ? _caller.object[field.name] : null) /}
		#{/if}
		
		<span class="crudHelp">
			&{am}
			%{ play.data.validation.Validation.getValidators(_caller.type.entityClass, fieldName, 'object').each() { }%
				%{
					switch (it.annotation.annotationType().name.substring(21)) {
					    case "Required":
					        out.println(messages.get('crud.help.required'))
							break;
						case "MinSize":
							out.println(messages.get('crud.help.minlength', it.annotation.value()))
							break;
						case "Range":
							out.println(messages.get('crud.help.range', it.annotation.min(), it.annotation.max()))
							break;
						case "Min":
							out.println(messages.get('crud.help.min', it.annotation.value()))
							break;
						case "Email":
					        out.println(messages.get('crud.help.email'))
							break;
						case "Equals":
							out.println(messages.get('crud.help.equals', it.params.equalsTo))
							break;
					}
				}%
			%{ } }%
		</span>
		
	%{ } }%
	
	</div>
	
#{/list}
